<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    
    <title>Drive Debug</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .btn {
            width: 100%;
            max-width: 300px;
            padding: 20px;
            margin: 10px 0;
            border-radius: 15px;
            border: 1px solid #333;
            background: #1c1c1e;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            cursor: pointer;
        }
        .btn-green { border-left: 5px solid #34C759; }
        .btn-blue { border-left: 5px solid #007AFF; }
        .btn-red { border-left: 5px solid #FF3B30; margin-top: 30px;}
        
        /* è¨˜éŒ„æª”é¡¯ç¤ºå€ */
        #console-log {
            width: 100%;
            max-width: 350px;
            height: 150px;
            background: #111;
            border: 1px solid #444;
            font-family: monospace;
            font-size: 12px;
            color: #0f0;
            padding: 10px;
            overflow-y: scroll;
            margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

    <h2>é™¤éŒ¯æ¨¡å¼</h2>

    <div class="btn btn-green" onclick="goHome()">ğŸ  å°èˆªå›å®¶ (Maps)</div>

    <p style="color:#888; font-size:0.8rem;">æ¸¬è©¦ç¥ç›¾ (è«‹ä¾åºå˜—è©¦):</p>
    <div class="btn btn-blue" onclick="testOmnie(1)">ğŸ›¡ï¸ ç¥ç›¾ æ¸¬è©¦ A (æ¨™æº–)</div>
    <div class="btn btn-blue" onclick="testOmnie(2)">ğŸ›¡ï¸ ç¥ç›¾ æ¸¬è©¦ B (æš´åŠ›)</div>
    <div class="btn btn-blue" onclick="testOmnie(3)">ğŸ›¡ï¸ ç¥ç›¾ æ¸¬è©¦ C (Activity)</div>

    <div id="installBtn" class="btn btn-red" style="display:none;">ğŸ“² å®‰è£åˆ°ä¸»ç•«é¢</div>

    <div id="console-log">ç³»çµ±æ—¥èªŒåˆå§‹åŒ–...</div>

    <script>
        // --- æ—¥èªŒåŠŸèƒ½ (å¹«æ‚¨æŠ“å‡ºéŒ¯èª¤) ---
        const logBox = document.getElementById('console-log');
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logBox.innerText += `\n[${time}] ${msg}`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(msg);
        }

        // --- 1. PWA å®‰è£è¨ºæ–· ---
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        // æª¢æŸ¥ Service Worker æ˜¯å¦å­˜åœ¨
        if ('serviceWorker' in navigator) {
            log("æª¢æŸ¥ SW æ”¯æ´: æ˜¯");
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => log("âœ… SW è¨»å†ŠæˆåŠŸ! Scope: " + reg.scope))
                .catch(err => log("âŒ SW è¨»å†Šå¤±æ•—: " + err.message));
        } else {
            log("âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Service Worker");
        }

        // ç›£è½å®‰è£äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            log("âœ… æ•æ‰åˆ°å®‰è£äº‹ä»¶ (beforeinstallprompt)");
            installBtn.style.display = 'block'; // é¡¯ç¤ºæŒ‰éˆ•
            installBtn.innerText = "ğŸ“² æŒ‰æ­¤å®‰è£ PWA (å¯ç”¨)";
        });

        installBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    log("ä½¿ç”¨è€…é¸æ“‡: " + choiceResult.outcome);
                    deferredPrompt = null;
                });
            } else {
                log("âš ï¸ ç„¡æ³•å®‰è£ï¼šç€è¦½å™¨æœªè§¸ç™¼äº‹ä»¶");
            }
        });

        // --- 2. å°èˆªåŠŸèƒ½ ---
        function goHome() {
            log("å•Ÿå‹• Google Maps...");
            // ä½¿ç”¨ Universal Linkï¼Œè¿™æ˜¯ç›®å‰æœ€ç¨³çš„
            window.location.href = "https://www.google.com/maps/dir/?api=1&destination=Home&travelmode=driving";
        }

        // --- 3. ç¥ç›¾å¤šé‡æ¸¬è©¦ ---
        function testOmnie(mode) {
            const pkg = "com.omnie.app";
            const fallback = `https://play.google.com/store/apps/details?id=${pkg}`;
            let intent = "";

            if (mode === 1) {
                log("æ¸¬è©¦ A: æ¨™æº– Intent");
                // æœ€ä¹¾æ·¨çš„å¯«æ³•ï¼Œä¾è³´ Android ç³»çµ±è§£æ
                intent = `intent://#Intent;scheme=package;package=${pkg};end`;
            } 
            else if (mode === 2) {
                log("æ¸¬è©¦ B: å¼·åˆ¶ Launcher");
                // æ¨¡æ“¬é»æ“Šæ¡Œé¢åœ–ç¤º
                intent = `intent:#Intent;action=android.intent.action.MAIN;category=android.intent.category.LAUNCHER;package=${pkg};S.browser_fallback_url=${encodeURIComponent(fallback)};end`;
            } 
            else if (mode === 3) {
                log("æ¸¬è©¦ C: æŒ‡å®š MainActivity");
                // ç›´æ¥æŒ‡å®š Activity è·¯å¾‘ (é€™æ˜¯çŒœæ¸¬çš„è·¯å¾‘ï¼Œå¦‚æœç¥ç›¾æœ‰æ”¹åå¯èƒ½æœƒå¤±æ•—)
                // é€šå¸¸æ˜¯ com.omnie.app.MainActivity æˆ– .ui.MainActivity
                intent = `intent://#Intent;component=com.omnie.app/com.omnie.app.MainActivity;S.browser_fallback_url=${encodeURIComponent(fallback)};end`;
            }

            // å˜—è©¦åŸ·è¡Œ
            setTimeout(() => {
                window.location.href = intent;
            }, 100);
        }

        // --- å•Ÿå‹•æª¢æŸ¥ ---
        window.addEventListener('load', () => {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log("æ¨¡å¼: å·²å®‰è£ (Standalone)");
            } else {
                log("æ¨¡å¼: ç€è¦½å™¨åˆ†é  (Browser)");
                // æª¢æŸ¥ manifest æ˜¯å¦èƒ½è®€å–
                fetch('./manifest.json')
                    .then(res => {
                        if(res.ok) log("âœ… manifest.json è®€å–æ­£å¸¸");
                        else log("âŒ manifest.json è®€å–å¤±æ•— (404?)");
                    })
                    .catch(err => log("âŒ manifest.json è«‹æ±‚éŒ¯èª¤"));
            }
        });
    </script>
</body>
</html>